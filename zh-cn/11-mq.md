# 理解消息中间件与常见问题

![访问统计](https://visitor-badge.glitch.me/badge?page_id=senlypan.qa.11-mq&left_color=blue&right_color=red)

> 作者: 潘深练
>
> 创建: 2022-05-28

## 脑图概览

<iframe id="embed_dom" name="embed_dom" frameborder="0" 
    style="display: block;width: 100%;height: 500px;" 
    src="https://www.processon.com/embed/628892f9f346fb4244d0672c"></iframe>


## QA

### 1、消息中间件如何做生产幂等（考虑成本）？

也就是消除消息的重复消费问题（消费幂等），核心思路是使用 **唯一标识**，来标记某条消息是否已经处理过。

- 唯一标识（考虑存储成本/性能/准确率）
    - 解决方案：
        - **一、基本数据库方案**
            - 1、使用数据库自增主键，或者唯一键来保证数据不会重复变动；
            - 2、使用中间状态，以及状态变动有序性来判断业务是否已经被处理；
            - 3、利用一张日志表来记录已经处理成功的消息的 ID，如果新到的消息 ID 已经在日志表中，那么就不再处理这条消息；
            - 4、或者消息唯一标识，在 Redis 等 NoSQL 中维护一个处理缓存，判断是否已经处理过；
            - 5、如果消费者业务流程比较长，则需要开发者自己保证整个业务消费逻辑中数据处理的事务性。
        - **二、更优数据结构方案**
            - 1、索引树
            - 2、bitmap
            - 3、布隆过滤器
            - 4、布谷鸟过滤器

### 2、消息中间件如何保障消息全局有序？

- 全局时钟（根源）
- 一个分区，或多分区生产者打标
- 业务仲裁
- 拓展：研究spanner实现思路

### 3、消息中间件有哪些故障模型的存在？

思路：首先要清楚故障模型关系到可靠性，保障可靠性其实就是控制它的故障模型，所以需要枚举出可能造成故障的环节有哪些？然后把他们归一下类，就成故障模型了。

- 人为故障
- 网络故障
- 硬件故障（内存磁盘故障）
- 拜占庭故障
- more

### 4、消息中间件做故障转移（解决方案）有几种方法？各有什么优劣？

思路：针对第3点中归类的故障模型，就可以思考解决方案，故障模型和解决方案是1对多的关系，先有故障模型，才有的这些方案。

- 解决【人为故障】靠制度
- 解决【网络故障】靠重试（重试便要思考幂等问题）
- 解决【硬件故障（内存磁盘故障）】靠副本（副本就要考虑持久化问题）/冗余
- 解决【拜占庭故障】可以靠共识算法
- more

延伸理解：**设计系统时**也是一样的思路，先把故障模型列出来，在思考解决方案，解决方案罗列巨细了，**系统可靠性**也就有了基本保障。因为故障模型是可靠性问题的定义。

延伸学习：[《拜占庭将军问题是什么？区块链如何防范恶意节点？-哔哩哔哩】》](https://b23.tv/IiBLmSI)


## 参考

- [《云原生时代消息中间件的演进路线 | 阿里中间件》](https://mp.weixin.qq.com/s/1e-ceBDrNinttYt6HmeMXw)

- [《消息中间件应用的常见问题与方案｜得物技术》](https://mp.weixin.qq.com/s/60V3eoV_jFxBwsK6NiHM-g)

- [《下一代消息平台 Pulsar 到底是什么》](https://juejin.cn/post/6920028494848573448)

- [《架构决策之消息中间件MQ系列六-Pulsar》](https://blog.csdn.net/tcy83/article/details/106731392)



